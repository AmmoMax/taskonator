![Bot](img/bot.jpg "Bot")
# Телеграм бот для получения и сдачи заданий

---

Функционал МВП:

- задание добавляется в базу вручную
- админ может посмотреть список текущих активных заданий с привязкой к пользователям(если он есть)
- админ видит список заданий ожидающих оценки

- пользователь может посмотреть список заданий внутри семьи
- пользователь может записать одно задание на себя
- пользователь может сдать задание

---

### Базовый воркфлоу:

1. Создание семьи
- Пользователь подключается к боту и создает семью. После создания семьи пользователь становится администратором семьи.
- Пользователь(теперь он админ) добавляет в семью других пользователей.
- Админ добавляет задание в базу данных.
- Пользователь берет задание на себя.
- Пользователь выполняет задание и отправляет его на проверку.
- Админ проверяет задание и принимает его или отправляет на доработку.

> Один пользователь может быть частью одной семьи, но семья может состоять из нескольких пользователей.


### Функционал админа:

- управление заданиями - создание, изменение, удаление, аппрув ожидающих либо отказ с комментарием
- управление пользователями (в более полной версии)

### Функционал пользователя:

- посмотреть список текущих заданий
- посмотреть свой баланс
- выбрать задание и записать на себя
- сдать задание


## Команды бота:

/start - команда начала работы. Проверяет пользователя если он новый - предлагает ему создать семью
 или присоединиться к существующей

## Команды для пользователя:

/task_list - выводит список текущих заданий с клавиатурой - пользователь может нажать на кнопку чтобы взять задание

/my_tasks - посмотреть список моих заданий со статусами

/submit_task - сдать задание, команда для пользователя - попытаться сдать текущее задание

***

## Модели данных: 

Пользователь:
  - Описывает любого пользователя бота. Пользователь может быть администратором семьи или обычным пользователем.
  - привязан к одной семье
  - может иметь несколько заданий
  - имеет баланс в баллах за выполненные задания

Семья:
  - описывает семью к которой принадлежит пользователь
  - одна семья может содержать много пользователей, но у пользователя может быть только одна семья

Задание: 
  - описывает задание которое пользователь может взять на выполнение
  - имеет описание, статус, дату создания и дату окончания.
  - привязано к пользователю, 
  - У одного задания может быть только один пользователь, но один пользователь может иметь несколько заданий.



### Вариант структуры БД:


-family
  - id(PK)
  - name(varchar)
  - created_date(datetime)
  - updated_date(datetime)

- user
    - user_id(PK)
    - family_id(many-to-one)
    - username(varchar)
    - balance(float)
    - is_admin(Bool)
    - created_date(datetime)
    - updated_date(datetime)

- task
    - task_id(PK)
    - user_id(many-to-one)
    - description(text)
    - cost(float)
    - attachment(blob)
    - status(?)
    - created_date(datetime)
    - expiration_date(datetime)

### Список сервисов:
- Сервис управления пользователями
- Сервис управления семьями
- Сервис управления заданиями
- Сервис управления баллами


Примерная логика взимодействия Бота с другими компонентами:

 - /start -> проверяет id пользователя в менеджере -> возвращает список команд для админа или обычного пользователя
 - /task_list -> запросил список активных свободных заданий у TaskManager -> вернул ответ пользователю
 - сообщение от клиента - не команда -> пытается зарегистрировать это как задание для пользователя через TaskManager -> отправляет ответ клиенту (тут может быть два варианта: клиент нажал на кнопку и отправил реальное задание - тогда оно привязывается к нему и для него формируется ответ1, либо клиент просто написал сообщение которое не связано с заданием, тогда ему отправляется заглушка)
 - /create_task(только для админа) -> делает запрос в UserManager является ли этот пользователь админом -> Запускает диалог создания задания -> Добавляет новое задание через TaskManager
 - /submit_task -> запрос в UserManager для сдачи текущего задания -> отправляет пользователю ответ


Надо разделить хэндлеры по функционалу:
 - хэндлеры для работы с семьей
 - хэндлеры для работы с пользователями
 - хэндлеры для работы с заданиями

Основной класс бота будет собирать в себе только роутеры и объект бота, который запускается в поллинг через диспетчера


### Регистрация семьи

- Пользователь отправляет команду /new_family
- Бот создает новую семью и назначает ее администратором пользователя
  - А если пользователь уже состоит в семье - бот отправляет сообщение о том, что он уже состоит в семье(?)
  - Новая семья создается в базе
  - Пользователь привязывается к семье и его статус меняется на администратора


### Создание задания

- Пользователь отправляет команду /create_task
- Бот проверяет принадлежит ли пользователь к семье и является ли он администратором
  - Если да - бот запускает диалог создания задания
    - Сохраняет задание в базу данных
  - Если нет - бот отправляет сообщение о том, что пользователь не является администратором или не принадлежит к семье

### Выбор задания
- Пользователь отправляет команду /task_list
- Бот проверяет принадлежит ли пользователь к семье
  - Если да - бот отправляет список заданий доступных внутри семьи и со статусом New 
    - Пользователь может выбрать задание и взять его на себя
  - Если нет - бот отправляет сообщение о том, что пользователь не принадлежит к семье

### Сдача задания
- Пользователь отправляет команду /submit_task
- Бот проверяет есть ли у пользователя текущее задание
  - Если да - бот отправляет сообщение о том, что задание отправлено на проверку, статус задания меняется на Submitted
  - Если нет - бот отправляет сообщение о том, что у пользователя нет текущего задания и предлагает посмотреть текущие

